// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  fullName  String   @map("full_name")
  role      UserRole @default(USER)
  schoolId  String   @map("school_id")
  school    School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  conversations     Conversation[]
  sentMessages      Message[]
  broadcastMessages BroadcastMessage[]
  attendanceRecords Attendance[]
  refreshTokens     RefreshToken[]

  @@map("users")
}

enum UserRole {
  ADMIN
  USER
}

model School {
  id                    String             @id @default(cuid())
  schoolName            String             @map("school_name")
  displayName           String             @map("display_name")
  sidebarHeaderSubtitle String             @map("sidebar_header_subtitle")
  instituteType         InstituteType      @map("institute_type")
  schoolAddress         String             @map("school_address")
  zipcode               String
  schoolType            SchoolType         @map("school_type")
  establishmentYear     Int                @map("establishment_year")
  principalName         String             @map("principal_name")
  principalEmail        String             @map("principal_email")
  principalPhone        String             @map("principal_phone")
  logoUrl               String?            @map("logo_url")
  primaryColor          String             @default("#3B82F6") @map("primary_color")
  secondaryColor        String             @default("#10B981") @map("secondary_color")
  schoolStartTime       String             @map("school_start_time")
  schoolEndTime         String             @map("school_end_time")
  classesOffered        Json               @default("[]") @map("classes_offered")
  defaultSections       Json               @default("[]") @map("default_sections")
  trialEndsAt           DateTime           @map("trial_ends_at")
  subscriptionStatus    SubscriptionStatus @default(TRIAL) @map("subscription_status")
  subscriptionPlan      SubscriptionPlan   @default(REGULAR) @map("subscription_plan")
  subscriptionExpiresAt DateTime?          @map("subscription_expires_at")
  studentLimit          Int                @default(200) @map("student_limit")
  licenseKey            String?            @unique @map("license_key")
  createdBy             String             @map("created_by")
  createdAt             DateTime           @default(now()) @map("created_at")

  users               User[]
  students            Student[]
  attendance          Attendance[]
  gatekeepers         Gatekeeper[]
  batches             Batch[]
  conversations       Conversation[]
  broadcastMessages   BroadcastMessage[]
  holidays            Holiday[]
  registrationLinks   RegistrationLink[]
  paymentTransactions PaymentTransaction[]

  @@map("schools")
}

enum InstituteType {
  SCHOOL
  IELTS_CENTER
  COMPUTER_CENTER
  TUITION_CENTER
  COACHING_CENTER
}

enum SchoolType {
  PUBLIC
  PRIVATE
}

enum SubscriptionStatus {
  TRIAL
  ACTIVE
  EXPIRED
  CANCELLED
}

enum SubscriptionPlan {
  REGULAR
  ULTRA
}

model Student {
  id                  String        @id @default(cuid())
  schoolId            String        @map("school_id")
  batchId             String?       @map("batch_id")
  batchIds            Json          @default("[]") @map("batch_ids")
  studentBatchTimings Json          @default("[]") @map("student_batch_timings")
  studentId           String        @unique @map("student_id")
  fullName            String        @map("full_name")
  fatherName          String        @map("father_name")
  motherName          String        @map("mother_name")
  guardianName        String?       @map("guardian_name")
  dateOfBirth         DateTime      @map("date_of_birth")
  class               String
  section             String
  courseName          String?       @map("course_name")
  courseDuration      String?       @map("course_duration")
  batchTiming         String?       @map("batch_timing")
  targetScore         String?       @map("target_score")
  currentLevel        String?       @map("current_level")
  subjects            String?
  studentPhoto        String?       @map("student_photo")
  address             String?
  emergencyContact    String?       @map("emergency_contact")
  parentWhatsapp      String?       @map("parent_whatsapp")
  parentEmail         String?       @map("parent_email")
  medicalInfo         String?       @map("medical_info")
  previousSchool      String?       @map("previous_school")
  enrollmentDate      DateTime      @map("enrollment_date")
  courseStartDate     DateTime?     @map("course_start_date")
  courseEndDate       DateTime?     @map("course_end_date")
  status              StudentStatus @default(ACTIVE)
  fcmToken            String?       @map("fcm_token")
  fcmTokenUpdatedAt   DateTime?     @map("fcm_token_updated_at")
  apiAccessToken      String?       @unique @map("api_access_token")
  createdAt           DateTime      @default(now()) @map("created_at")
  createdBy           String        @map("created_by")

  school        School         @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  batch         Batch?         @relation(fields: [batchId], references: [id], onDelete: SetNull)
  attendance    Attendance[]
  conversations Conversation[]

  @@map("students")
}

enum StudentStatus {
  ACTIVE
  COMPLETED
  DROPPED
  TRANSFERRED
}

model Attendance {
  id             String           @id @default(cuid())
  schoolId       String           @map("school_id")
  studentId      String           @map("student_id")
  gatekeeperId   String?          @map("gatekeeper_id")
  entryTime      DateTime?        @map("entry_time")
  exitTime       DateTime?        @map("exit_time")
  attendanceDate DateTime         @map("attendance_date")
  status         AttendanceStatus
  isLate         Boolean          @default(false) @map("is_late")
  whatsappSent   Boolean          @default(false) @map("whatsapp_sent")
  notes          String?
  createdAt      DateTime         @default(now()) @map("created_at")
  createdBy      String           @map("created_by")

  school     School      @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  student    Student     @relation(fields: [studentId], references: [id], onDelete: Cascade)
  gatekeeper Gatekeeper? @relation(fields: [gatekeeperId], references: [id], onDelete: SetNull)
  User       User?       @relation(fields: [userId], references: [id])
  userId     String?

  @@map("attendance")
}

enum AttendanceStatus {
  PRESENT
  LATE
  ABSENT
  EARLY_DEPARTURE
}

model Gatekeeper {
  id              String           @id @default(cuid())
  schoolId        String           @map("school_id")
  fullName        String           @map("full_name")
  gatekeeperId    String           @unique @map("gatekeeper_id")
  gatekeeperPhoto String?          @map("gatekeeper_photo")
  address         String?
  fatherName      String?          @map("father_name")
  phoneNumber     String?          @map("phone_number")
  email           String?
  gateNumber      String?          @map("gate_number")
  shiftStart      String           @map("shift_start")
  shiftEnd        String           @map("shift_end")
  accessLink      String           @unique @map("access_link")
  status          GatekeeperStatus @default(ACTIVE)
  createdAt       DateTime         @default(now()) @map("created_at")
  createdBy       String           @map("created_by")

  school     School       @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  attendance Attendance[]

  @@map("gatekeepers")
}

enum GatekeeperStatus {
  ACTIVE
  INACTIVE
}

model Batch {
  id                String      @id @default(cuid())
  schoolId          String      @map("school_id")
  batchName         String      @map("batch_name")
  batchCode         String      @unique @map("batch_code")
  startTime         String      @map("start_time")
  endTime           String      @map("end_time")
  entryTime         String      @map("entry_time")
  exitTime          String      @map("exit_time")
  daysOfWeek        Json        @default("[]") @map("days_of_week")
  courseName        String?     @map("course_name")
  instructorName    String?     @map("instructor_name")
  maxCapacity       Int         @map("max_capacity")
  currentEnrollment Int         @default(0) @map("current_enrollment")
  batchType         BatchType   @map("batch_type")
  feeAmount         Float?      @map("fee_amount")
  startDate         DateTime    @map("start_date")
  endDate           DateTime    @map("end_date")
  status            BatchStatus @default(ACTIVE)
  createdAt         DateTime    @default(now()) @map("created_at")

  school   School    @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  students Student[]

  @@map("batches")
}

enum BatchType {
  REGULAR
  WEEKEND
  INTENSIVE
  ONLINE
}

enum BatchStatus {
  ACTIVE
  INACTIVE
  COMPLETED
}

model Conversation {
  id                 String           @id @default(cuid())
  schoolId           String           @map("school_id")
  studentId          String           @map("student_id")
  parentUserId       String           @map("parent_user_id")
  teacherUserId      String?          @map("teacher_user_id")
  conversationType   ConversationType @map("conversation_type")
  lastMessage        String?          @map("last_message")
  lastMessageTime    DateTime?        @map("last_message_time")
  lastMessageSender  String?          @map("last_message_sender")
  parentUnreadCount  Int              @default(0) @map("parent_unread_count")
  teacherUnreadCount Int              @default(0) @map("teacher_unread_count")
  isActive           Boolean          @default(true) @map("is_active")
  createdAt          DateTime         @default(now()) @map("created_at")

  school     School    @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  student    Student   @relation(fields: [studentId], references: [id], onDelete: Cascade)
  parentUser User      @relation(fields: [parentUserId], references: [id], onDelete: Cascade)
  messages   Message[]

  @@map("conversations")
}

enum ConversationType {
  PARENT_TEACHER
  PARENT_PRINCIPAL
  BROADCAST
}

model Message {
  id                 String      @id @default(cuid())
  conversationId     String      @map("conversation_id")
  senderUserId       String      @map("sender_user_id")
  senderType         SenderType  @map("sender_type")
  messageText        String      @map("message_text")
  messageType        MessageType @default(TEXT) @map("message_type")
  deliveredToParent  Boolean     @default(false) @map("delivered_to_parent")
  isReadByParent     Boolean     @default(false) @map("is_read_by_parent")
  deliveredToTeacher Boolean     @default(false) @map("delivered_to_teacher")
  isReadByTeacher    Boolean     @default(false) @map("is_read_by_teacher")
  attachmentUrl      String?     @map("attachment_url")
  replyToMessageId   String?     @map("reply_to_message_id")
  createdAt          DateTime    @default(now()) @map("created_at")

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender       User         @relation(fields: [senderUserId], references: [id], onDelete: Cascade)

  @@map("messages")
}

enum SenderType {
  PARENT
  TEACHER
  PRINCIPAL
  SYSTEM
}

enum MessageType {
  TEXT
  IMAGE
  FILE
  SYSTEM
}

model BroadcastMessage {
  id               String              @id @default(cuid())
  schoolId         String              @map("school_id")
  senderUserId     String              @map("sender_user_id")
  senderType       BroadcastSenderType @map("sender_type")
  messageTitle     String              @map("message_title")
  messageText      String              @map("message_text")
  targetAudience   TargetAudience      @map("target_audience")
  targetClass      String?             @map("target_class")
  targetStudentIds Json                @default("[]") @map("target_student_ids")
  sentCount        Int                 @default(0) @map("sent_count")
  readCount        Int                 @default(0) @map("read_count")
  priority         MessagePriority     @default(NORMAL)
  createdAt        DateTime            @default(now()) @map("created_at")

  school School @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  sender User   @relation(fields: [senderUserId], references: [id], onDelete: Cascade)

  @@map("broadcast_messages")
}

enum BroadcastSenderType {
  PRINCIPAL
  TEACHER
}

enum TargetAudience {
  ALL_PARENTS
  SPECIFIC_CLASS
  SPECIFIC_STUDENTS
}

enum MessagePriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

model Holiday {
  id          String      @id @default(cuid())
  schoolId    String      @map("school_id")
  holidayName String      @map("holiday_name")
  startDate   DateTime    @map("start_date")
  endDate     DateTime    @map("end_date")
  holidayType HolidayType @map("holiday_type")
  description String?
  createdAt   DateTime    @default(now()) @map("created_at")

  school School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@map("holidays")
}

enum HolidayType {
  NATIONAL
  REGIONAL
  SCHOOL_SPECIFIC
  OPTIONAL
}

model LicenseKey {
  id             String          @id @default(cuid())
  licenseKey     String          @unique @map("license_key")
  schoolId       String?         @map("school_id")
  schoolName     String          @map("school_name")
  principalEmail String          @map("principal_email")
  principalName  String          @map("principal_name")
  duration       String
  planType       LicensePlanType @map("plan_type")
  emailSent      Boolean         @default(false) @map("email_sent")
  emailSentAt    DateTime?       @map("email_sent_at")
  isActivated    Boolean         @default(false) @map("is_activated")
  activatedAt    DateTime?       @map("activated_at")
  expiresAt      DateTime        @map("expires_at")
  notes          String?
  createdAt      DateTime        @default(now()) @map("created_at")

  @@map("license_keys")
}

enum LicensePlanType {
  REGULAR
  CUSTOM
}

model RegistrationLink {
  id                 String   @id @default(cuid())
  schoolId           String   @map("school_id")
  linkId             String   @unique @map("link_id")
  expiryDate         DateTime @map("expiry_date")
  classFilter        String?  @map("class_filter")
  isActive           Boolean  @default(true) @map("is_active")
  registrationsCount Int      @default(0) @map("registrations_count")
  maxRegistrations   Int      @map("max_registrations")
  createdAt          DateTime @default(now()) @map("created_at")

  school School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@map("registration_links")
}

model Notification {
  id          String   @id @default(cuid())
  userEmail   String   @map("user_email")
  title       String
  description String
  link        String?
  isRead      Boolean  @default(false) @map("is_read")
  createdAt   DateTime @default(now()) @map("created_at")

  @@map("notifications")
}

model CustomPlanRequest {
  id                  String           @id @default(cuid())
  instituteName       String           @map("institute_name")
  instituteType       String           @map("institute_type")
  contactPerson       String           @map("contact_person")
  email               String
  phone               String
  studentCount        String           @map("student_count")
  durationMonths      String           @map("duration_months")
  currentChallenges   String           @map("current_challenges")
  budgetRange         String           @map("budget_range")
  specialRequirements String           @map("special_requirements")
  status              CustomPlanStatus @default(PENDING)
  requestedAt         DateTime         @default(now()) @map("requested_at")
  adminNotes          String?          @map("admin_notes")
  generatedLicenseKey String?          @map("generated_license_key")
  planType            String?          @map("plan_type")
  approvedPrice       Float?           @map("approved_price")

  @@map("custom_plan_requests")
}

enum CustomPlanStatus {
  PENDING
  CONTACTED
  QUOTED
  ACCEPTED
  REJECTED
}

model RefreshToken {
  id        String    @id @default(cuid())
  userId    String    @map("user_id")
  token     String    @unique
  expiresAt DateTime  @map("expires_at")
  revokedAt DateTime? @map("revoked_at")
  createdAt DateTime  @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}

model PaymentTransaction {
  id         String   @id @default(cuid())
  schoolId   String   @map("school_id")
  userId     String?  @map("user_id")
  orderId    String   @unique @map("order_id")
  paymentId  String?  @map("payment_id")
  signature  String?  @map("signature")
  amount     Float    @map("amount")
  currency   String   @default("INR") @map("currency")
  status     String   @default("PENDING") @map("status")
  plan       String?  @map("plan")
  notes      Json?    @map("notes")
  rawPayload Json?    @map("raw_payload")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  school School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@map("payment_transactions")
}
